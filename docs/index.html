<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RTA Tool</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/codemirror/codemirror.css" rel="stylesheet">
    <link href="css/codemirror/theme/elegant.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>

    <div class="container-fluid">

        <div style="background: #36569c; color: white; padding: 10px 20px; display: flex; align-items: center;">
            <span style="font-size: 18px; font-weight: bold; margin-right: 20px;">RTA Tool</span>
            <span style="font-size: 12px; opacity: 0.8;">Reconfigurable Timed Automata: Animated Analysis</span>
        </div>

        <div class="main-row">

            <div class="col-panel col-left">
                <div class="panel-header">Editor</div>
                <div class="scroll-area">

                    <label style="font-size: 12px; color: #777;">Exemplos:</label>
                    <select id="examplesSelect" class="form-control input-sm" onchange="loadExample()"
                        style="margin-bottom: 10px;">
                        <option value="">Selecione...</option>
                    </select>

                    <textarea id="codeEditor">init s0...</textarea>

                    <button class="btn btn-primary btn-block" style="margin-top: 10px;" onclick="loadAndRender()">
                        <span class="glyphicon glyphicon-play"></span> Carregar & Simular
                    </button>

                    <hr>

                    <div class="panel-group" id="accordion">

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion"
                                        href="#collapseExport">Exportar & Download</a></h4>
                            </div>
                            <div id="collapseExport" class="panel-collapse collapse in">
                                <div class="panel-body">
                                    <!--<label>mCRL2:</label>
                                    <button class="btn btn-xs btn-default btn-block" onclick="downloadMcrl2()">Baixar
                                        .mcrl2</button>-->

                                    <label style="margin-top: 5px;">Uppaal:</label>
                                    <div class="btn-group btn-group-justified">
                                        <div class="btn-group"><button class="btn btn-xs btn-default"
                                                onclick="downloadUppaal('rg')">RG</button></div>
                                        <div class="btn-group"><button class="btn btn-xs btn-default"
                                                onclick="downloadUppaal('tgrg')">TGRG</button></div>
                                        <div class="btn-group"><button class="btn btn-xs btn-default"
                                                onclick="downloadUppaal('glts')">GLTS</button></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion"
                                        href="#collapseTrans">Tradução</a></h4>
                            </div>
                            <div id="collapseTrans" class="panel-collapse collapse">
                                <div class="panel-body">
                                    <button class="btn btn-sm btn-info btn-block" onclick="translateToGLTS()">Traduzir
                                        para GLTS (Editor)</button>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion"
                                        href="#collapseStats">Análise</a></h4>
                            </div>
                            <div id="collapseStats" class="panel-collapse collapse">
                                <div class="panel-body">
                                    <button class="btn btn-xs btn-default" onclick="showStats()">Estatísticas</button>
                                    <button class="btn btn-xs btn-danger" onclick="checkProblems()">Buscar
                                        Problemas</button>
                                    <div id="analysisResult"></div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <div class="col-panel col-center">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#cyTab" data-toggle="tab">Grafo (Interativo)</a></li>
                    <li><a href="#mermaidTab" data-toggle="tab">Mermaid</a></li>
                    <li><a href="#txtTab" data-toggle="tab" onclick="renderTextView()">Texto</a></li>
                </ul>

                <div class="tab-content"
                    style="flex: 1; display: flex; overflow: hidden; position: relative; height: 100%;">

                    <div role="tabpanel" class="tab-pane active" id="cyTab" style="width: 100%; height: 100%;">
                        <div id="cytoscapeMainContainer"></div>
                    </div>

                    <div id="cy-context-menu" class="dropdown clearfix" style="position: fixed; display: none; z-index: 9999;">
                        <ul class="dropdown-menu" role="menu" style="display:block; position:static; margin-bottom:5px;">
                        </ul>
                    </div>

                    <div class="modal fade" id="quickModal" tabindex="-1" role="dialog" style="z-index: 100000;">
                        <div class="modal-dialog modal-sm" role="document" style="margin-top: 20vh; z-index: 9999999999;">
                            <div class="modal-content">
                            <div class="modal-header" style="padding: 10px 15px; background: #f8f9fa;">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h5 class="modal-title" id="quickModalTitle" style="font-weight: bold;">Título</h5>
                            </div>
                            <div class="modal-body" style="padding: 15px;">
                                <form id="quickModalForm">
                                    <div id="quickModalInputs"></div>
                                </form>
                            </div>
                            <div class="modal-footer" style="padding: 10px;">
                                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary btn-sm" id="quickModalSaveBtn">Salvar</button>
                            </div>
                            </div>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="mermaidTab"
                        style="width: 100%; height: 100%; overflow: auto; padding: 10px;">
                        <div class="btn-group" style="margin-bottom: 15px;">
                            <button class="btn btn-default btn-sm" onclick="setMermaidMode('full')">Passo Atual
                                (Completo)</button>
                            <button class="btn btn-default btn-sm" onclick="setMermaidMode('simple')">Passo Atual
                                (Simples)</button>
                            <button class="btn btn-primary btn-sm" onclick="showLTS()">All Steps (LTS)</button>
                        </div>
                        <div id="mermaidContainer" class="mermaid"></div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="txtTab"
                        style="width: 100%; height: 100%; overflow: auto;">
                        <pre id="textContainer" style="margin: 0; min-height: 100%; border: none;"></pre>
                    </div>
                </div>
            </div>

            <div class="col-panel col-right">

                 <div style="height: 35%; display: flex; flex-direction: column; overflow: hidden; border-bottom: 1px solid #ddd;">
                    <div class="panel-header">Simulação</div>
                    <div class="scroll-area" id="sidePanel">
                        <p class="text-muted text-center" style="margin-top: 50px;">
                            Carregue um modelo<br>para iniciar.
                        </p>
                    </div>
                </div>

                 <div style="flex: 1; display: flex; flex-direction: column; background: #fff;">
                    <div class="panel-header" style="background: #f8f9fa;">Verificação PDL</div>
                    <div class="scroll-area" style="padding: 10px;">

                        <div class="form-group">
                            <label style="font-size: 11px; font-weight:bold;">1. Estados encontrados:</label>
                            <div id="pdl-states-list"
                                style="margin-bottom: 5px; max-height: 80px; overflow-y: auto; border: 1px solid #eee; padding: 5px; background: #fdfdfd;">
                                <span class="text-muted" style="font-size:10px;">Carregue um modelo...</span>
                            </div>
                            <input type="text" id="pdlState" class="form-control input-sm"
                                placeholder="Clique num estado acima...">
                        </div>

                        <hr style="margin: 5px 0;">

                        <div class="form-group" style="margin-bottom: 5px;">
                            <label style="font-size: 11px; font-weight:bold;">2. Variáveis (Dados):</label>
                            <div id="pdl-vars-list" style="margin-bottom: 5px; max-height: 60px; overflow-y: auto; border: 1px solid #eee; padding: 5px; background: #f9fff9;">
                                <span class="text-muted" style="font-size:10px;">Nenhuma variável.</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="font-size: 11px; font-weight:bold;">2. Elementos para Fórmula (Ações e Estados):</label>
                            
                            <div id="pdl-actions-list" style="margin-bottom: 5px; max-height: 80px; overflow-y: auto; border: 1px solid #eee; padding: 5px; background: #fdfdfd;">
                                <span class="text-muted" style="font-size:10px;">...</span>
                            </div>

                            <div class="btn-toolbar" style="margin-bottom: 5px;">
                                <!-- Modalidades -->
                                <div class="btn-group btn-group-xs" style="margin-right: 2px;">
                                    <button class="btn btn-default" title="Diamond" onclick="insertPdl('⟨','⟩')">⟨a⟩</button>
                                    <button class="btn btn-default" title="Box" onclick="insertPdl('[',']')">[a]</button>
                                </div>
                                
                                <!-- Comparadores (Visual Bonito) -->
                                <div class="btn-group btn-group-xs" style="margin-right: 2px;">
                                    <button class="btn btn-default" onclick="insertPdl(' = ')">=</button>
                                    <button class="btn btn-default" onclick="insertPdl(' ≠ ')">≠</button>
                                    <button class="btn btn-default" onclick="insertPdl(' ≤ ')">≤</button>
                                    <button class="btn btn-default" onclick="insertPdl(' ≥ ')">≥</button>
                                    <button class="btn btn-default" onclick="insertPdl(' < ')">&lt;</button>
                                    <button class="btn btn-default" onclick="insertPdl(' > ')">&gt;</button>
                                </div>

                                <!-- Lógica -->
                                <div class="btn-group btn-group-xs">
                                    <button class="btn btn-default" onclick="insertPdl('¬')">¬</button>
                                    <button class="btn btn-default" onclick="insertPdl(' ∧ ')">∧</button>
                                    <button class="btn btn-default" onclick="insertPdl(' ∨ ')">∨</button>
                                    <button class="btn btn-default" onclick="insertPdl(' → ')">→</button>
                                    <button class="btn btn-default" onclick="insertPdl('true')">⊤</button>
                                </div>
                            </div>

                            <input type="text" id="pdlFormula" class="form-control input-sm"
                                placeholder="Fórmula (Ex: <a>true)">
                        </div>

                        <button class="btn btn-success btn-sm btn-block" onclick="runPdl()">Verificar</button>
                        <div id="pdlResult" style="margin-top: 10px; font-size: 12px; font-weight: bold;"></div>
                    </div>
                </div>

            </div>

            <div class="modal fade" id="edgeDetailModal" tabindex="-1" role="dialog" aria-labelledby="edgeDetailLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="edgeDetailLabel">Detalhes da Transição</h4>
                        </div>
                        <div class="modal-body" style="padding: 0;">
                            <pre id="edgeDetailContent" class="language-clike"
                                style="margin: 0; border: none; border-radius: 0; padding: 20px; font-size: 13px; min-height: 100px; max-height: 400px;"></pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="js/static/jquery-1.10.2.min.js"></script>
    <script src="js/static/bootstrap.min.js"></script>
    <script src="js/static/codemirror/codemirror.js"></script>
    <script src="js/static/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="js/static/codemirror/mode/caos/caos.js"></script>
    <script src="js/static/mermaid.min.js"></script>
    <script src="js/cy/cytoscape.min.js"></script>
    <script src="js/cy/dagre.min.js"></script>
    <script src="js/cy/cytoscape-dagre.js"></script>
    <script src="js/main.js"></script>
    <script src="js/gen/main.js"></script>
    <script src="js/cy/beatifulEditor.js"></script>
    <script src="js/cy/main.js"></script>

    <script>
        mermaid.initialize({ startOnLoad: false });
        CodeMirror.defineMode("rta", function () {
            return {
                token: function (stream, state) {

                    if (stream.eatSpace()) return null;

                    if (stream.match("//")) {
                        stream.skipToEnd();
                        return "comment";
                    }

                    if (stream.match(/\b(init|aut|int|clock|inv|if|then|else|disabled)\b/)) {
                        return "keyword";
                    }

                    if (stream.match(/--> | ->>| --! | --x | ---->| --#--/)) {
                        return "atom";
                    }

                    if (stream.match(/:=|==|!=|<=|>=|[+\-*\/=<>&|]/)) {
                        return "operator";
                    }



                    stream.next();
                    return "variable";
                }
            };
        });
        var editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
            lineNumbers: true,
            mode: "rta",
            theme: "rta-light"
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            try {

                var examplesJson =  RTA.getExamples();
                var examples = JSON.parse(examplesJson);
                var select = document.getElementById("examplesSelect");
                var exampleToLoad = "Simple"; 

                if (examples[exampleToLoad]) {
                    select.value = examples[exampleToLoad];
                    
                    setTimeout(function() {
                        if (typeof loadExample === 'function' && typeof loadAndRender === 'function') {
                            loadExample();
                            loadAndRender();
                        }
                    }, 100);
                }

            } catch(e) { console.error("Erro ao carregar exemplos", e); }
        });
    </script>
</body>

</html>